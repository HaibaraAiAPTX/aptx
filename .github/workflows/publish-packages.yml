name: Publish Packages

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.29.1'
  PNPM_STRICT_SSL: 'false'
  NPM_REGISTRY_URL: 'https://winserver.devserver.ink:14873/'
  NPM_REGISTRY_AUTH_KEY: '//winserver.devserver.ink:14873/:_authToken'

jobs:
  # Stage 1: Build all packages
  build:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:packages

      - name: Pack build artifacts
        shell: bash
        run: |
          shopt -s nullglob
          artifacts=(packages/*/dist)
          if [ ${#artifacts[@]} -eq 0 ]; then
            echo "No dist directories were produced by build."
            exit 1
          fi
          tar -czf packages-build-artifacts.tgz "${artifacts[@]}"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-build-artifacts
          path: packages-build-artifacts.tgz
          if-no-files-found: error
          compression-level: 0
          retention-days: 1

  # Stage 2: Publish base packages (no internal dependencies)
  publish-base:
    needs: build
    timeout-minutes: 20
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - token-store
          - api-core
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages-build-artifacts
          path: .

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Extract build artifacts
        shell: bash
        run: tar -xzf packages-build-artifacts.tgz

      - name: Validate dist artifacts
        shell: bash
        run: |
          dist_dir="packages/${{ matrix.package }}/dist"
          if [ ! -d "$dist_dir" ] || [ -z "$(ls -A "$dist_dir")" ]; then
            echo "Missing or empty dist directory: $dist_dir"
            exit 1
          fi

      - name: Validate package contents
        working-directory: packages/${{ matrix.package }}
        run: pnpm pack --dry-run >/dev/null

      - name: Configure npm registry
        run: |
          pnpm config set registry "${NPM_REGISTRY_URL}"
          pnpm config set strict-ssl false
          pnpm config set "${NPM_REGISTRY_AUTH_KEY}" "${NPM_TOKEN}"
        env:
          NPM_TOKEN: ${{ secrets.WINSERVER_NPM_TOKEN }}

      - name: Publish @aptx/${{ matrix.package }}
        working-directory: packages/${{ matrix.package }}
        run: |
          name=$(node -p "require('./package.json').name")
          version=$(node -p "require('./package.json').version")
          if pnpm view "${name}@${version}" version >/dev/null 2>&1; then
            echo "SKIP: ${name}@${version} already exists"
          else
            pnpm publish --ignore-scripts --no-git-checks --no-strict-ssl
            echo "PUBLISHED: ${name}@${version}"
          fi

  # Stage 3: Publish layer 2 packages (depends on base)
  publish-layer-2:
    needs: publish-base
    timeout-minutes: 20
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - token-store-cookie
          - token-store-ssr-cookie
          - api-client
          - api-plugin-auth
          - api-plugin-csrf
          - api-plugin-retry
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages-build-artifacts
          path: .

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Extract build artifacts
        shell: bash
        run: tar -xzf packages-build-artifacts.tgz

      - name: Validate dist artifacts
        shell: bash
        run: |
          dist_dir="packages/${{ matrix.package }}/dist"
          if [ ! -d "$dist_dir" ] || [ -z "$(ls -A "$dist_dir")" ]; then
            echo "Missing or empty dist directory: $dist_dir"
            exit 1
          fi

      - name: Validate package contents
        working-directory: packages/${{ matrix.package }}
        run: pnpm pack --dry-run >/dev/null

      - name: Configure npm registry
        run: |
          pnpm config set registry "${NPM_REGISTRY_URL}"
          pnpm config set strict-ssl false
          pnpm config set "${NPM_REGISTRY_AUTH_KEY}" "${NPM_TOKEN}"
        env:
          NPM_TOKEN: ${{ secrets.WINSERVER_NPM_TOKEN }}

      - name: Publish @aptx/${{ matrix.package }}
        working-directory: packages/${{ matrix.package }}
        run: |
          name=$(node -p "require('./package.json').name")
          version=$(node -p "require('./package.json').version")
          if pnpm view "${name}@${version}" version >/dev/null 2>&1; then
            echo "SKIP: ${name}@${version} already exists"
          else
            pnpm publish --ignore-scripts --no-git-checks --no-strict-ssl
            echo "PUBLISHED: ${name}@${version}"
          fi

  # Stage 4: Publish query adapter (depends on api-client)
  publish-query-adapter:
    needs: publish-layer-2
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages-build-artifacts
          path: .

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Extract build artifacts
        shell: bash
        run: tar -xzf packages-build-artifacts.tgz

      - name: Validate dist artifacts
        shell: bash
        run: |
          dist_dir="packages/api-query-adapter/dist"
          if [ ! -d "$dist_dir" ] || [ -z "$(ls -A "$dist_dir")" ]; then
            echo "Missing or empty dist directory: $dist_dir"
            exit 1
          fi

      - name: Validate package contents
        working-directory: packages/api-query-adapter
        run: pnpm pack --dry-run >/dev/null

      - name: Configure npm registry
        run: |
          pnpm config set registry "${NPM_REGISTRY_URL}"
          pnpm config set strict-ssl false
          pnpm config set "${NPM_REGISTRY_AUTH_KEY}" "${NPM_TOKEN}"
        env:
          NPM_TOKEN: ${{ secrets.WINSERVER_NPM_TOKEN }}

      - name: Publish @aptx/api-query-adapter
        working-directory: packages/api-query-adapter
        run: |
          name=$(node -p "require('./package.json').name")
          version=$(node -p "require('./package.json').version")
          if pnpm view "${name}@${version}" version >/dev/null 2>&1; then
            echo "SKIP: ${name}@${version} already exists"
          else
            pnpm publish --ignore-scripts --no-git-checks --no-strict-ssl
            echo "PUBLISHED: ${name}@${version}"
          fi

  # Stage 5: Publish query framework packages (depends on query-adapter)
  publish-query-framework:
    needs: publish-query-adapter
    timeout-minutes: 20
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - api-query-react
          - api-query-vue
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages-build-artifacts
          path: .

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Extract build artifacts
        shell: bash
        run: tar -xzf packages-build-artifacts.tgz

      - name: Validate dist artifacts
        shell: bash
        run: |
          dist_dir="packages/${{ matrix.package }}/dist"
          if [ ! -d "$dist_dir" ] || [ -z "$(ls -A "$dist_dir")" ]; then
            echo "Missing or empty dist directory: $dist_dir"
            exit 1
          fi

      - name: Validate package contents
        working-directory: packages/${{ matrix.package }}
        run: pnpm pack --dry-run >/dev/null

      - name: Configure npm registry
        run: |
          pnpm config set registry "${NPM_REGISTRY_URL}"
          pnpm config set strict-ssl false
          pnpm config set "${NPM_REGISTRY_AUTH_KEY}" "${NPM_TOKEN}"
        env:
          NPM_TOKEN: ${{ secrets.WINSERVER_NPM_TOKEN }}

      - name: Publish @aptx/${{ matrix.package }}
        working-directory: packages/${{ matrix.package }}
        run: |
          name=$(node -p "require('./package.json').name")
          version=$(node -p "require('./package.json').version")
          if pnpm view "${name}@${version}" version >/dev/null 2>&1; then
            echo "SKIP: ${name}@${version} already exists"
          else
            pnpm publish --ignore-scripts --no-git-checks --no-strict-ssl
            echo "PUBLISHED: ${name}@${version}"
          fi

  # Summary
  summary:
    needs: [publish-base, publish-layer-2, publish-query-adapter, publish-query-framework]
    if: always()
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo "## Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.publish-base.result }}" == "success" ] && \
             [ "${{ needs.publish-layer-2.result }}" == "success" ] && \
             [ "${{ needs.publish-query-adapter.result }}" == "success" ] && \
             [ "${{ needs.publish-query-framework.result }}" == "success" ]; then
            echo "All packages published successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|" >> $GITHUB_STEP_SUMMARY
            echo "| base | ${{ needs.publish-base.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| layer-2 | ${{ needs.publish-layer-2.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| query-adapter | ${{ needs.publish-query-adapter.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| query-framework | ${{ needs.publish-query-framework.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
